services:
  arcane:
    image: ghcr.io/getarcaneapp/arcane:latest
    restart: unless-stopped
    healthcheck:
      test: "curl --fail http://localhost:3552/api/health || exit 1"
      interval: 1m
      retries: 5
      start_interval: 5s
      start_period: 15s
      timeout: 5s

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${ARCANE_DATA_VOLUME}:/app/data
    env_file:
      - ./.env
    environment:
      PUID: "1000"
      PGID: "1000"
      LOG_LEVEL: "info"
      LOG_JSON: "true"
      APP_URL: "https://${ARCANE_HOST}"
      OIDC_ENABLED: "true"
      OIDC_CLIENT_ID: "arcane"
      OIDC_SCOPES: "openid email profile groups"
      OIDC_ADMIN_CLIAM: "groups"
      OIDC_ADMIN_VALUE: "admin"
      OIDC_MERGE_ACCOUNTS: "true"
      DATABASE_URL: "file:data/arcane.db?_pragma=journal_mode(WAL)&_pragma=busy_timeout(2500)&_txlock=immediate"

    networks:
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.arcane.tls=true"
      - "traefik.http.routers.arcane.entrypoints=websecure"
      - "traefik.http.routers.arcane.tls.certresolver=cf"
      - "traefik.http.routers.arcane.rule=Host(`${ARCANE_HOST}`)"
      - "traefik.http.services.arcane.loadbalancer.server.port=3552"
      - "traefik.http.routers.arcane.middlewares=tailnet-whitelist@file,authelia@file"

networks:
  traefik:
    external: true
